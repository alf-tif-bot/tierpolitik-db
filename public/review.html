<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crawler Review</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;padding:24px}
  .wrap{max-width:1280px;margin:0 auto}
  h1{margin:0 0 8px}
  p{color:#a9bfd8}
  code{background:#1f2937;border:1px solid #334155;color:#dbeafe;padding:1px 5px;border-radius:6px}
  .links{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
  .links a{display:inline-block;border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;text-decoration:none;color:#dbeafe}
  .status{margin:10px 0 14px;color:#bfdbfe}
  button{margin-right:6px;border:1px solid #4b5563;border-radius:8px;padding:5px 9px;background:#22364f;color:#e8effa;cursor:pointer}
  button:hover{background:#2b4565}
  .export{margin:10px 0 12px}
  table{width:100%;border-collapse:collapse;background:#111827;border:1px solid #334155;border-radius:12px;overflow:hidden}
  td,th{border-bottom:1px solid #1f2937;padding:10px;vertical-align:top;text-align:left}
  th{background:#1b2433;color:#dbeafe;font-weight:700;position:sticky;top:0}
  tr:hover td{background:#172133}
  .orig-link{display:inline-block;margin-top:6px;color:#93c5fd}
  .muted{color:#94a3b8}
  .pending{color:#f59e0b}
  .historic{color:#94a3b8}
  .fast-lane{color:#fbbf24;font-weight:700}
  .row-fastlane td{background:rgba(251,191,36,.08)}
  .fastlane-wrap{margin:12px 0 16px;padding:12px;border:1px solid #475569;border-radius:10px;background:#111827}
  .fastlane-wrap h2{font-size:16px;margin:0 0 10px;color:#fde68a}
  .fastlane-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
  .fastlane-card{border:1px solid #334155;border-radius:10px;padding:10px;background:#0b1220}
  .fastlane-head{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
  .fastlane-score{font-weight:700;color:#fde68a}
  .fastlane-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:8px}
  @media (max-width: 760px){
    body{padding:12px}
    td,th{padding:8px;font-size:13px}
    .fastlane-wrap{position:sticky;top:0;z-index:5}
  }
</style>
</head>
<body>
  <main class="wrap">
    <h1>Review-Ansicht</h1>
    <p>Es werden standardmässig nur <strong>offene</strong> relevante Einträge gezeigt (queued/new). Bereits bearbeitete Einträge bleiben ausgeblendet und können bei Bedarf über den Button eingeblendet werden. Wenn ein Vorstoss in mehreren Sprachen vorliegt, wird bevorzugt die <strong>deutsche Version</strong> angezeigt. Approve/Reject blendet den Eintrag sofort aus; mit <strong>Entscheidungen exportieren</strong> + <code>npm run crawler:apply-review</code> wird es in JSON/DB übernommen.</p>
    <p class="status" id="status-summary">Status-Summen (sichtbar): offen=0, gutgeheissen=0, publiziert=0</p>
    <nav class="links"><a href="/">Zur App</a><a href="/user-input.html">User-Input</a></nav>
    <p class="export"><button onclick="exportDecisions()">Entscheidungen exportieren</button> <button onclick="toggleDecided()" id="toggle-decided">Bereits bearbeitete anzeigen</button></p>
    <p id="decision-status" class="muted" aria-live="polite"></p>
    
    <table>
      <thead>
        <tr>
          <th>Titel</th>
          <th>Typ</th>
          <th>Quelle</th>
          <th>Score</th>
          <th>Treffer</th>
          <th>Status</th>
          <th>Warum relevant / nicht</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody>
<tr data-id="ch-parliament-business-de:20254831-de" data-status="queued" data-fastlane-tagged="0" class="">
<td>
  <strong>25.4831 · Einheimische Produktionssysteme fördern anstatt Importbedingungen für mit Chlor behandeltem Hühnerfleisch lockern</strong><br>
  <small>Kurzfassung: Das Geschäft behandelt hühner. Einordnung: Es hat einen indirekten bzw. unklaren Tierbezug.</small><br>
  <a class="orig-link" href="https://www.parlament.ch/de/ratsbetrieb/suche-curia-vista/geschaeft?AffairId=20254831" target="_blank" rel="noopener noreferrer">Original-Vorstoss öffnen</a>
</td>
<td>Crawler</td>
<td>
  <div>Parlament.ch Curia Vista (DE)</div>
  <small class="muted">ch-parliament-business-de</small>
</td>
<td>0.73<br><small class="muted">Priorität: mittel</small></td>
<td>hühner, landwirtschaft, agriculture, agricoltura</td>
<td>offen (<strong class="pending">offen</strong>)</td>
<td><small><div><strong>Einordnung:</strong> neutral / unklar</div><div><strong>Bewertung:</strong> Klare Tier-Relevanz (Schlüsselbegriffe + Score erfüllt)</div><div><strong>Tier-Begriffe:</strong> hühner</div><div><strong>Kontext:</strong> landwirtschaft, agriculture, agricoltura</div><div><strong>Score:</strong> 0.73</div></small></td>
<td>
<button onclick="setDecision(this,'ch-parliament-business-de:20254831-de','approved')">Gutheissen</button>
<button onclick="setDecision(this,'ch-parliament-business-de:20254831-de','rejected')">Ablehnen</button>
<button class="tag-btn" data-tag-btn="ch-parliament-business-de:20254831-de" onclick="toggleFastlaneTag(this,'ch-parliament-business-de:20254831-de')">â˜† Fastlane</button>
</td>
</tr>
<tr data-id="ch-municipal-parliament-bern-zurich:municipal-bern-api-d0f7b26541424c43aab28a91744f6ba9" data-status="queued" data-fastlane-tagged="0" class="">
<td>
  <strong>Bern · Nachtfahrverbot für Mähroboter - für Igel und andere Kleintiere</strong><br>
  <small>Gemeinde Bern (Stadtrat Bern) · 2025.SR.0388 · Eingereicht</small><br>
  <a class="orig-link" href="https://stadtrat.bern.ch/de/geschaefte/detail.php?gid=d0f7b26541424c43aab28a91744f6ba9" target="_blank" rel="noopener noreferrer">Original-Vorstoss öffnen</a>
</td>
<td>Crawler</td>
<td>
  <div>Municipal parliaments (Bern, Zürich)</div>
  <small class="muted">ch-municipal-parliament-bern-zurich</small>
</td>
<td>0.18<br><small class="muted">Priorität: niedriger</small></td>
<td>motion</td>
<td>offen (<strong class="pending">offen</strong>)</td>
<td><small><div><strong>Einordnung:</strong> neutral / unklar</div><div><strong>Bewertung:</strong> Thematisch relevant und von priorisiertem Parlamentsprofil</div><div><strong>Kontext:</strong> motion</div><div><strong>Priorisierte Profile:</strong> tobias sennhauser</div><div><strong>Score:</strong> 0.18</div></small></td>
<td>
<button onclick="setDecision(this,'ch-municipal-parliament-bern-zurich:municipal-bern-api-d0f7b26541424c43aab28a91744f6ba9','approved')">Gutheissen</button>
<button onclick="setDecision(this,'ch-municipal-parliament-bern-zurich:municipal-bern-api-d0f7b26541424c43aab28a91744f6ba9','rejected')">Ablehnen</button>
<button class="tag-btn" data-tag-btn="ch-municipal-parliament-bern-zurich:municipal-bern-api-d0f7b26541424c43aab28a91744f6ba9" onclick="toggleFastlaneTag(this,'ch-municipal-parliament-bern-zurich:municipal-bern-api-d0f7b26541424c43aab28a91744f6ba9')">â˜† Fastlane</button>
</td>
</tr></tbody>
    </table>
  </main>
<script>
const key='tierpolitik.review';
const uiKey='tierpolitik.review.ui';
const fastlaneTagKey='tierpolitik.review.fastlaneTags';
const initialFastlaneTags={"ch-parliament-business-de:20223210-de":{"fastlane":true,"taggedAt":"2026-02-14T10:46:37.937Z"},"ch-parliament-business-de:20250078-de":{"fastlane":true,"taggedAt":"2026-02-14T08:25:12.936Z"},"ch-parliament-business-de:20213835-de":{"fastlane":true,"taggedAt":"2026-02-14T08:25:24.389Z"},"ch-parliament-business-de:20213405-de":{"fastlane":true,"taggedAt":"2026-02-14T08:25:32.546Z"},"ch-parliament-business-de:20233515-de":{"fastlane":true,"taggedAt":"2026-02-14T08:25:44.286Z"},"ch-parliament-business-de:20237115-de":{"fastlane":true,"taggedAt":"2026-02-14T08:25:54.185Z"},"ch-parliament-business-de:20227807-de":{"fastlane":true,"taggedAt":"2026-02-14T08:26:08.828Z"},"ch-parliament-business-de:20258205-de":{"fastlane":true,"taggedAt":"2026-02-14T08:26:27.637Z"},"ch-parliament-business-de:20244696-de":{"fastlane":true,"taggedAt":"2026-02-14T08:28:00.545Z"},"ch-parliament-business-de:20244695-de":{"fastlane":true,"taggedAt":"2026-02-14T08:28:13.450Z"},"ch-parliament-business-de:20244465-de":{"fastlane":true,"taggedAt":"2026-02-14T10:34:56.969Z"},"ch-parliament-business-de:20240436-de":{"fastlane":true,"taggedAt":"2026-02-14T10:44:57.766Z"},"ch-parliament-business-de:20223300-de":{"fastlane":true,"taggedAt":"2026-02-14T10:45:09.382Z"},"ch-parliament-business-de:20213363-de":{"fastlane":true,"taggedAt":"2026-02-14T10:45:19.848Z"},"ch-parliament-business-de:20213364-de":{"fastlane":true,"taggedAt":"2026-02-14T10:45:28.520Z"},"ch-parliament-business-de:20212004-de":{"fastlane":true,"taggedAt":"2026-02-14T10:45:41.919Z"},"ch-parliament-business-de:20253976-de":{"fastlane":true,"taggedAt":"2026-02-14T10:46:04.703Z"},"ch-parliament-business-de:20250059-de":{"fastlane":true,"taggedAt":"2026-02-14T10:46:16.584Z"},"ch-parliament-business-de:20232009-de":{"fastlane":true,"taggedAt":"2026-02-14T10:46:29.666Z"},"ch-parliament-business-de:20214167-de":{"fastlane":true,"taggedAt":"2026-02-14T10:47:07.633Z"},"ch-parliament-business-de:20252027-de":{"fastlane":true,"taggedAt":"2026-02-14T10:47:24.017Z"},"ch-parliament-business-de:20244344-de":{"fastlane":true,"taggedAt":"2026-02-14T10:47:42.196Z"},"ch-parliament-business-de:20243296-de":{"fastlane":true,"taggedAt":"2026-02-14T10:47:57.369Z"},"ch-parliament-business-de:20223952-de":{"fastlane":true,"taggedAt":"2026-02-14T10:48:16.353Z"},"ch-parliament-business-de:20223808-de":{"fastlane":true,"taggedAt":"2026-02-14T10:48:30.730Z"},"ch-parliament-business-de:20258063-de":{"fastlane":true,"taggedAt":"2026-02-14T10:48:46.707Z"},"ch-parliament-business-de:20213229-de":{"fastlane":true,"taggedAt":"2026-02-14T10:50:13.054Z"},"ch-parliament-business-de:20223302-de":{"fastlane":true,"taggedAt":"2026-02-14T10:50:31.269Z"},"ch-parliament-business-de:20231034-de":{"fastlane":true,"taggedAt":"2026-02-14T10:50:39.327Z"},"ch-parliament-business-de:20243277-de":{"fastlane":true,"taggedAt":"2026-02-14T10:51:01.036Z"},"ch-parliament-business-de:20254144-de":{"fastlane":true,"taggedAt":"2026-02-14T10:51:22.151Z"},"ch-parliament-business-de:20213703-de":{"fastlane":true,"taggedAt":"2026-02-14T10:51:32.388Z"},"ch-parliament-business-de:20212027-de":{"fastlane":true,"taggedAt":"2026-02-14T10:51:44.244Z"},"ch-municipal-parliament-bern-zurich:municipal-bern-api-c6c65c8ce8a84435af97428996dadc64":{"fastlane":true,"taggedAt":"2026-02-14T18:37:06.036Z"},"ch-municipal-parliament-bern-zurich:municipal-bern-api-13284d70bb124c23a1bbba427e8a7c5c":{"fastlane":true,"taggedAt":"2026-02-14T18:37:25.611Z"},"user-input:user-bern-2026sr0019-tierpark-alternativen-toetung":{"fastlane":true,"taggedAt":"2026-02-14T18:43:35.637Z"},"ch-municipal-parliament-bern-zurich:municipal-bern-api-b7e265b3766d43119b5279f5ea795e91":{"fastlane":true,"taggedAt":"2026-02-14T18:44:17.747Z"},"user-input:user-bern-2026sr0056-biodiversitaet":{"fastlane":true,"taggedAt":"2026-02-14T22:33:21.861Z"},"ch-parliament-business-de:20203021-de":{"fastlane":true,"taggedAt":"2026-02-14T22:33:43.182Z"},"ch-cantonal-be-rss:www-gr-be-ch-de-start-geschaefte-geschaeftssuche-geschaeftsdetail-html-guid-57c34c78ddf541f098b29f4c2be2cbfa":{"fastlane":true,"taggedAt":"2026-02-15T09:51:04.074Z"}};
const API_BASE=(localStorage.getItem('tierpolitik.apiBase')||'').replace(//$/,'');
const safeJsonParse=(raw, fallback={})=>{
  try { return JSON.parse(raw || JSON.stringify(fallback)); }
  catch { return fallback; }
};
const read=()=>safeJsonParse(localStorage.getItem(key),{});
const write=(v)=>localStorage.setItem(key,JSON.stringify(v,null,2));
const readFastlaneTags=()=>{
  const local = safeJsonParse(localStorage.getItem(fastlaneTagKey),{});
  return { ...initialFastlaneTags, ...local };
};
const writeFastlaneTags=(v)=>localStorage.setItem(fastlaneTagKey,JSON.stringify(v));
const readUi=()=>safeJsonParse(localStorage.getItem(uiKey),{});
const writeUi=(v)=>localStorage.setItem(uiKey,JSON.stringify(v));

let showDecided = false;

function updateStatusSummary(){
  const stats = { offen: 0, gutgeheissen: 0, publiziert: 0 }
  let visibleRows = 0
  document.querySelectorAll('tr[data-id]').forEach((row)=>{
    const hidden = row.style.display === 'none'
    if (hidden) return
    visibleRows += 1
    const status = String(row.getAttribute('data-status') || '').toLowerCase()
    if (status === 'queued' || status === 'new') stats.offen += 1
    else if (status === 'approved') stats.gutheissen += 1
    else if (status === 'published') stats.publiziert += 1
  })
  const el = document.getElementById('status-summary')
  if (el) {
    el.textContent = 'Status-Summen (sichtbar): offen=' + stats.offen + ', gutgeheissen=' + stats.gutheissen + ', publiziert=' + stats.publiziert
    if (visibleRows === 0) el.textContent += ' · keine offenen Einträge'
  }
}

function hideDecidedRows(){
  const decisions = read();
  const rows = [...document.querySelectorAll('tr[data-id]')]
  const decidedById = {}

  const localAffairDecided = new Set(Object.keys(decisions)
    .filter((id) => String(id).startsWith('ch-parliament-'))
    .map((id) => {
      const external = String(id).split(':')[1] || ''
      return String(external).split('-')[0]
    })
    .filter(Boolean))

  rows.forEach((row)=>{
    const id = row.getAttribute('data-id');
    if (!id) return
    const status = row.getAttribute('data-status') || ''
    const serverDecided = status !== 'queued' && status !== 'new'
    const localDecided = Boolean(decisions[id])
    const isParliamentEntry = String(id).startsWith('ch-parliament-')
    const affairId = isParliamentEntry ? (String(id).split(':')[1] || '').split('-')[0] : ''
    const localAffairHit = Boolean(affairId) && localAffairDecided.has(affairId)
    const decided = serverDecided || localDecided || localAffairHit
    decidedById[id] = decided
    row.style.display = (!showDecided && decided) ? 'none' : ''
  });

  document.querySelectorAll('.fastlane-card[data-id]').forEach((card)=>{
    const id = card.getAttribute('data-id')
    if (!id) return
    const decided = Boolean(decidedById[id]) || Boolean(decisions[id])
    card.style.display = decided ? 'none' : ''
  })

  const btn = document.getElementById('toggle-decided')
  if (btn) btn.textContent = showDecided ? 'Bearbeitete ausblenden' : 'Bereits bearbeitete anzeigen'
  updateStatusSummary();
}

function toggleDecided(){
  showDecided = !showDecided
  writeUi({ showDecided })
  hideDecidedRows()
}

function renderFastlaneTagButton(id){
  const tags = readFastlaneTags();
  const isTagged = Boolean(tags[id]?.fastlane);
  document.querySelectorAll('[data-tag-btn="' + id + '"]').forEach((btn)=>{
    btn.textContent = isTagged ? 'â­ Fastlane' : 'â˜† Fastlane';
  });
}

async function toggleFastlaneTag(btn,id){
  const tags = readFastlaneTags();
  const next = !Boolean(tags[id]?.fastlane);
  const taggedAt = new Date().toISOString();
  if (btn) btn.disabled = true;

  try {
    const res = await fetch(API_BASE + '/review-fastlane-tag', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ id, fastlane: next, taggedAt }),
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || 'Fastlane tag API failed');
    }
  } catch(err) {
    alert('Konnte Fastlane-Tag nicht speichern.');
    console.error(err);
    if (btn) btn.disabled = false;
    return;
  }

  tags[id] = { fastlane: next, taggedAt };
  writeFastlaneTags(tags);
  renderFastlaneTagButton(id);

  const row = document.querySelector('tr[data-id="' + id + '"]');
  if (row) row.setAttribute('data-fastlane-tagged', next ? '1' : '0');
  const card = document.querySelector('.fastlane-card[data-id="' + id + '"]');
  if (card) card.setAttribute('data-fastlane-tagged', next ? '1' : '0');

  if (btn) btn.disabled = false;
}

async function setDecision(btn,id,status){
  const decidedAt = new Date().toISOString();
  const statusEl = document.getElementById('decision-status');
  if (statusEl) statusEl.textContent = 'Speichere Entscheidung…';

  if (btn) btn.disabled = true;

  // Optimistic UI: hide immediately, even if API is slow/unreachable.
  const row = document.querySelector('tr[data-id="' + id + '"]');
  if (row) {
    row.setAttribute('data-status', status)
    row.style.opacity = '0.72'
    row.style.display='none'
  }

  let serverOk = false;
  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 5000);

    const res = await fetch(API_BASE + '/review-decision', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ id, status, decidedAt }),
      signal: controller.signal,
    });

    clearTimeout(timer);

    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || 'Decision API failed');
    }
    serverOk = true;
  } catch(err) {
    console.warn('Review decision API unavailable, using local fallback', err);
  }

  try {
    const s=read();
    s[id]={status,decidedAt};
    write(s);
  } catch(err) {
    console.warn('Local decision persist failed', err)
  }

  const card = document.querySelector('.fastlane-card[data-id="' + id + '"]');
  if (card) card.style.display = 'none'
  updateStatusSummary();

  if (statusEl) {
    statusEl.textContent = serverOk
      ? 'Entscheidung gespeichert.'
      : 'Entscheidung lokal gespeichert (Server nicht erreichbar).';
  }
  if (btn) btn.disabled = false;
}
function exportDecisions(){
  const blob=new Blob([JSON.stringify(read(),null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='review-decisions.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

for (const id of Object.keys(readFastlaneTags())) renderFastlaneTagButton(id)
hideDecidedRows();
</script>
</body>
</html>