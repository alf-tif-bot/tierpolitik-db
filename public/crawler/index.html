<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crawler Debug</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:#0b1220;color:#e2e8f0;margin:0;padding:20px}
    h1{margin:0 0 8px}
    .muted{color:#94a3b8}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin:14px 0}
    .card{background:#111b30;border:1px solid #233252;border-radius:10px;padding:10px}
    table{width:100%;border-collapse:collapse;background:#111b30;border:1px solid #233252;border-radius:10px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid #1f2c46;text-align:left;font-size:13px}
    th{background:#0f1a2f;color:#cbd5e1}
    .ok{color:#22c55e}.warn{color:#f59e0b}.bad{color:#ef4444}
    code{color:#93c5fd}
  </style>
</head>
<body>
  <h1>crawler-debug</h1>
  <div class="muted">Direktlink: <code>/crawler</code> · Fokus: Warum fallen kantonale Items raus?</div>
  <p class="export view-controls" style="margin:10px 0 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button id="copy-report">Debug-Report kopieren</button>
    <span class="muted">→ kann 1:1 in den Chat eingefügt werden</span>
  </p>
  <div class="card" id="report-box" style="margin-bottom:14px"><div class="muted">Report wird geladen…</div></div>

  <div class="grid" id="kpis"></div>

  <h3>Kanton-Status (Review + Source-Fix)</h3>
  <table>
    <thead>
      <tr><th>Kanton</th><th>Open review</th><th>Source-fix</th><th>Top score</th><th>Hinweis</th></tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <h3 style="margin-top:20px">ZG Fokus (minutiös)</h3>
  <div class="grid" id="zg-kpis"></div>
  <table>
    <thead>
      <tr><th>Status</th><th>Drop-Grund</th><th>Score</th><th>Titel</th><th>URL</th></tr>
    </thead>
    <tbody id="zg-rows"></tbody>
  </table>

  <h3 style="margin-top:20px">ZG Top 10 Drops (reason codes)</h3>
  <table>
    <thead>
      <tr><th>ID</th><th>Reason</th><th>Score</th><th>Status</th><th>Titel</th></tr>
    </thead>
    <tbody id="zg-drops"></tbody>
  </table>

  <script>
    const by = (arr, fn) => arr.reduce((m, x) => { const k = fn(x); m[k] = (m[k]||0)+1; return m; }, {});

    const cantonFrom = (item) => {
      const fromExt = (item.externalId || '').split('-').pop()?.toUpperCase();
      return item.canton || fromExt || '??';
    };

    const detailLike = (url = '') => /\/geschaefte\/\d+|[?&]attid%5D=|[?&]attid=|affairid=\d+/i.test(String(url || ''));

    const dropReason = (item) => {
      const score = Number(item.score || Number((item.reviewReason||'').match(/score=([0-9.]+)/)?.[1] || 0));
      if (!item.sourceUrl || !detailLike(item.sourceUrl)) return 'no-detail-url';
      if (score < 0.4) return 'score-too-low';
      if ((item.reviewReason || '').toLowerCase().includes('duplicate')) return 'duplicate';
      return 'reviewable';
    };

    async function boot(){
      const [candRes, zgRes] = await Promise.all([
        fetch('/data/review-candidates.json', {cache:'no-store'}),
        fetch('/data/crawler-debug-zg.json', {cache:'no-store'}).catch(() => null),
      ]);
      const cand = await candRes.json();
      const zgDebug = zgRes && zgRes.ok ? await zgRes.json() : { counts: { raw: 0, open: 0, sourceFix: 0 }, raw: [] };
      const items = cand.items || [];
      const open = items.filter(i => ['queued','new'].includes(String(i.status||'').toLowerCase()));
      const sourceFix = (cand.sourceFix && cand.sourceFix.items) ? cand.sourceFix.items : [];

      const kpis = [
        ['Open review', open.length],
        ['Open kantonal', open.filter(i=>i.sourceId==='ch-cantonal-portal-core').length],
        ['Source-fix kantonal', sourceFix.length],
        ['Kantone total sichtbar', new Set([...open.map(cantonFrom), ...sourceFix.map(cantonFrom)].filter(Boolean)).size],
      ];
      document.getElementById('kpis').innerHTML = kpis.map(([k,v]) => `<div class="card"><div class="muted">${k}</div><div style="font-size:22px;font-weight:700">${v}</div></div>`).join('');

      const openCantonal = open.filter(i=>i.sourceId==='ch-cantonal-portal-core');
      const openByCant = by(openCantonal, cantonFrom);
      const fixByCant = by(sourceFix, cantonFrom);
      const topScore = {};
      for (const i of openCantonal) {
        const c = cantonFrom(i);
        topScore[c] = Math.max(topScore[c] || 0, Number(i.score || 0));
      }
      for (const i of sourceFix) {
        const c = cantonFrom(i);
        topScore[c] = Math.max(topScore[c] || 0, Number((i.reviewReason||'').match(/score=([0-9.]+)/)?.[1] || 0));
      }
      const cants = [...new Set([...Object.keys(topScore), ...Object.keys(openByCant), ...Object.keys(fixByCant)])].sort();

      document.getElementById('rows').innerHTML = cants.map(c => {
        const o = openByCant[c] || 0;
        const f = fixByCant[c] || 0;
        const s = (topScore[c] ?? 0).toFixed(2);
        const hint = o>0 ? '<span class="ok">reviewbar</span>' : (f>0 ? '<span class="warn">nur source-fix</span>' : '<span class="bad">kein Treffer</span>');
        return `<tr><td><strong>${c}</strong></td><td>${o}</td><td>${f}</td><td>${s}</td><td>${hint}</td></tr>`;
      }).join('');

      const zgOpen = openCantonal.filter(i => cantonFrom(i) === 'ZG').map(i => ({ ...i, _status: 'open' }));
      const zgFix = sourceFix.filter(i => cantonFrom(i) === 'ZG').map(i => ({ ...i, _status: 'source-fix' }));
      const zgRawOnly = (zgDebug.raw || []).map(i => ({ ...i, _status: 'raw-only' }));
      const zgMap = new Map();
      [...zgRawOnly, ...zgFix, ...zgOpen].forEach(i => zgMap.set(i.id || `${i._status}:${i.externalId || i.title}`, i));
      const zgAll = [...zgMap.values()].sort((a,b) => Number(b.score||0) - Number(a.score||0));

      const reasons = by(zgAll, dropReason);
      const stageCounts = zgDebug.counts || {};
      const zgKpis = [
        ['ZG discovered_links', stageCounts.discovered_links || 0],
        ['ZG extracted_candidates', stageCounts.extracted_candidates || 0],
        ['ZG normalized_items', stageCounts.normalized_items || 0],
        ['ZG filtered_out', stageCounts.filtered_out || 0],
        ['ZG raw', stageCounts.raw || 0],
        ['ZG open', zgOpen.length],
        ['ZG source-fix', zgFix.length],
        ['ZG no-detail-url', reasons['no-detail-url'] || 0],
        ['ZG score-too-low', reasons['score-too-low'] || 0],
      ];
      document.getElementById('zg-kpis').innerHTML = zgKpis.map(([k,v]) => `<div class="card"><div class="muted">${k}</div><div style="font-size:22px;font-weight:700">${v}</div></div>`).join('');

      document.getElementById('zg-rows').innerHTML = zgAll.map(i => {
        const r = dropReason(i);
        const score = Number(i.score || Number((i.reviewReason||'').match(/score=([0-9.]+)/)?.[1] || 0)).toFixed(2);
        const t = (i.title || '').replace(/</g,'&lt;');
        const u = String(i.sourceUrl || '');
        const uHtml = u ? `<a href="${u}" target="_blank" rel="noopener">open</a>` : '<span class="bad">no-url</span>';
        return `<tr><td>${i._status}</td><td><code>${r}</code></td><td>${score}</td><td>${t}</td><td>${uHtml}</td></tr>`;
      }).join('');

      const dropped = Array.isArray(zgDebug.top_dropped_examples) ? zgDebug.top_dropped_examples : [];
      document.getElementById('zg-drops').innerHTML = dropped.length
        ? dropped.map((d) => `<tr><td><code>${String(d.id || '')}</code></td><td><code>${String(d.reason || '')}</code></td><td>${Number(d.score || 0).toFixed(2)}</td><td>${String(d.status || '')}</td><td>${String(d.title || '').replace(/</g,'&lt;')}</td></tr>`).join('')
        : '<tr><td colspan="5" class="muted">Keine Drops im aktuellen Lauf</td></tr>';

      const report = [
        `crawler-debug report`,
        `open_review=${open.length}`,
        `open_kantonal=${openCantonal.length}`,
        `source_fix_kantonal=${sourceFix.length}`,
        `sichtbare_kantone=${cants.join(',') || '-'}`,
        `zg_discovered_links=${stageCounts.discovered_links || 0}`,
        `zg_extracted_candidates=${stageCounts.extracted_candidates || 0}`,
        `zg_normalized_items=${stageCounts.normalized_items || 0}`,
        `zg_filtered_out=${stageCounts.filtered_out || 0}`,
        `zg_raw=${zgDebug.counts?.raw || 0}`,
        `zg_open=${zgOpen.length}`,
        `zg_source_fix=${zgFix.length}`,
        `zg_no_detail_url=${reasons['no-detail-url'] || 0}`,
        `zg_score_too_low=${reasons['score-too-low'] || 0}`,
      ].join('\n');

      const box = document.getElementById('report-box');
      if (box) {
        const alarm = (zgDebug.counts?.discovered_links || 0) === 0
          ? '<div class="bad" style="margin-bottom:6px">⚠️ ZG-Collector liefert 0 Discovery-Links (harter Hinweis auf Source/Collector-Problem)</div>'
          : '';
        box.innerHTML = `${alarm}<pre style="margin:0;white-space:pre-wrap">${report}</pre>`;
      }

      const copyBtn = document.getElementById('copy-report');
      if (copyBtn) {
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(report);
            copyBtn.textContent = 'Kopiert ✅';
            setTimeout(() => copyBtn.textContent = 'Debug-Report kopieren', 1400);
          } catch {
            copyBtn.textContent = 'Kopieren fehlgeschlagen';
          }
        }
      }
    }
    boot().catch(err => {
      document.body.insertAdjacentHTML('beforeend', `<p class="bad">Fehler beim Laden: ${String(err)}</p>`)
    });
  </script>
</body>
</html>