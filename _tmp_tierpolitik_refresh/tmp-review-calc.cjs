const fs=require('fs');
const db=JSON.parse(fs.readFileSync('_tmp_tierpolitik_refresh/data/crawler-db.json','utf8'));
const localDecisions=fs.existsSync('_tmp_tierpolitik_refresh/data/review-decisions.json')?JSON.parse(fs.readFileSync('_tmp_tierpolitik_refresh/data/review-decisions.json','utf8')):{};
const cfg=JSON.parse(fs.readFileSync('_tmp_tierpolitik_refresh/crawler/config.sources.json','utf8'));
const enabled=new Set((cfg.length?cfg:(db.sources||[])).filter(s=>s.enabled!==false).map(s=>s.id));
const targetSinceTs=Date.UTC(2020,0,1,0,0,0);
const inH=i=>{const iso=i.publishedAt||i.fetchedAt;if(!iso)return false;const ts=Date.parse(String(iso));return !Number.isNaN(ts)&&ts>=targetSinceTs};
const isMunicipalOverviewNoise=(item)=>{const sid=String(item.sourceId||'');if(!sid.startsWith('ch-municipal-'))return false;const t=String(item.title||'').toLowerCase();const url=String((item.meta&&item.meta.sourceLink)||item.sourceUrl||'').toLowerCase();return t.includes('übersichtsseite')||t.includes('vorstösse und grsr-revisionen')||t.includes('antworten auf kleine anfragen')||t.includes('erste beratung von jugendvorst')||/^parlamentsgesch(ä|a)ft\s+municipal-/.test(t)||url.includes('vorstoesse-und-grsr-revisionen')||url.includes('antworten-auf-kleine-anfragen')||url.includes('suche-curia-vista/geschaeft?affairid=municipal')};
const M1=['tier','tierschutz','tierwohl','tierpark','tierversuch','wildtier','haustier','zoo','vogel','hund','katze','fisch','jagd'];
const M2=['biodivers','wald','siedlungsgebiet','landwirtschaftsgebiet','feuerwerk','lärm','laerm'];
const C1=['tier','tierschutz','tierwohl','tierhalteverbot','nutztier','masthuhn','geflügel','schlacht','tierversuch','3r','wildtier','jagd','zoo','tierpark','biodivers','artenschutz','wolf','fuchs'];
const isCantonalReadableRelevant=(item)=>{const sid=String(item.sourceId||'');if(!sid.startsWith('ch-cantonal-'))return true;const title=String(item.title||'').trim();const summary=String(item.summary||'').trim().toLowerCase();const text=(title+'\n'+summary+'\n'+String(item.body||'')).toLowerCase();const looks=/^parlamentsgesch(ä|a)ft\s+/i.test(title)||title.toLowerCase().includes('quell-adapter vorbereitet')||summary.includes('0 relevante linkziele erkannt')||summary.includes('verifying your browser');if(looks)return false;return C1.some(k=>text.includes(k));};
const isMunicipalTopicRelevant=(item)=>{const sid=String(item.sourceId||'');if(!sid.startsWith('ch-municipal-'))return true;const decisionKey=(item.sourceId||'')+':' +(item.externalId||'');const decisionStatus=String((localDecisions[decisionKey]||{}).status||'').toLowerCase();const feedbackQueued=String(item.reviewReason||'').toLowerCase().includes('user-feedback=irrelevant');if(feedbackQueued||decisionStatus==='queued'||decisionStatus==='new'||decisionStatus==='rejected')return true;const text=(item.title||'')+'\n'+(item.summary||'')+'\n'+(item.body||'');const low=text.toLowerCase();const strong=M1.filter(k=>low.includes(k)).length;const context=M2.filter(k=>low.includes(k)).length;return strong>0||context>=2;};
const norm=i=>String(i.status||'');
const base=[...db.items].filter(i=>enabled.has(i.sourceId)||String(i.sourceId||'')==='user-input').filter(i=>{const sid=String(i.sourceId||'');return sid.startsWith('ch-parliament-')||sid.startsWith('ch-municipal-')||sid.startsWith('ch-cantonal-')||sid==='user-input'}).filter(i=>['new','queued','approved','published'].includes(norm(i))).filter(i=>!isMunicipalOverviewNoise(i)).filter(isMunicipalTopicRelevant).filter(isCantonalReadableRelevant).filter(inH);
const affairKey=(i)=>{const sid=String(i.sourceId||'');const ext=String(i.externalId||'');if(sid.startsWith('ch-parliament-'))return ext.split('-')[0]||`${sid}:${ext}`;return `${sid}:${ext}`};
const langRank=i=>{const src=String(i.sourceId||'').toLowerCase();if(src.endsWith('-de'))return 0;if(src.endsWith('-fr'))return 1;if(src.endsWith('-it'))return 2;return 3};
const statusRank=i=>{const s=norm(i);if(s==='published')return 3;if(s==='approved')return 2;if(s==='queued'||s==='new')return 1;return 0};
const pick=(n,c)=>{const bs=statusRank(n)>statusRank(c),bl=langRank(n)<langRank(c),bsc=(n.score||0)>(c.score||0);return (bs||(!bs&&(bl||(!bl&&bsc))))?n:c};
const grouped=new Map();for(const i of base){const k=affairKey(i);grouped.set(k, grouped.has(k)?pick(i,grouped.get(k)):i)}
const normalize=v=>String(v||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
const extractNo=(i)=>{const t=String(i.title||'').replace(/\s+/g,' ').trim();const m=t.match(/\b(\d{2}\.\d{2,4})\b/);if(m&&m[1])return m[1];const raw=String(i.externalId||'').split('-')[0];const num=raw.match(/^(\d{4})(\d{2,4})$/);if(num){const yy=num[1].slice(2);const suf=String(Number(num[2]));if(suf&&suf!=='NaN')return `${yy}.${suf}`;}return ''};
const hardKey=i=>{const sid=String(i.sourceId||'');if(!sid.startsWith('ch-parliament-'))return `id:${sid}:${i.externalId||''}`;const no=extractNo(i);const nt=normalize(String(i.title||'').replace(/\b\d{2}\.\d{2,4}\b/g,''));if(no&&nt)return `hard:${no}|${nt}`;if(no)return `hard:${no}`;return `id:${sid}:${i.externalId||''}`};
const hard=new Map();for(const i of grouped.values()){const k=hardKey(i);hard.set(k,hard.has(k)?pick(i,hard.get(k)):i)}
const review=[...hard.values()];
const decisions=localDecisions;
const localAffairDecided=new Set(Object.keys(decisions).filter(id=>String(id).startsWith('ch-parliament-')).map(id=>(String(id).split(':')[1]||'').split('-')[0]).filter(Boolean));
const open=review.filter(i=>{const id=`${i.sourceId}:${i.externalId}`;const status=norm(i);const serverDecided=status!=='queued'&&status!=='new';const localDecided=Boolean(decisions[id]);const isPar=String(id).startsWith('ch-parliament-');const affair=isPar?(String(id).split(':')[1]||'').split('-')[0]:'';const localAffairHit=Boolean(affair)&&localAffairDecided.has(affair);return !(serverDecided||localDecided||localAffairHit);});
const bucket={Bund:0,Kanton:0,Stadt:0,Sonstiges:0};for(const i of open){const sid=String(i.sourceId||'');if(sid.startsWith('ch-parliament-'))bucket.Bund++;else if(sid.startsWith('ch-cantonal-'))bucket.Kanton++;else if(sid.startsWith('ch-municipal-'))bucket.Stadt++;else bucket.Sonstiges++;}
console.log(JSON.stringify({reviewTotal:review.length,openTotal:open.length,bucket},null,2));
